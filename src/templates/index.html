<!DOCTYPE
    html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous"
    >
    <title>Upload de CSV</title>
</head>
<body style="padding-top: 1rem;">
    <main class="container">
        <section class="w-75 mb-5">
            <h1 id="mainText">Enviar transações</h1>
        
            <form class="mb-3" method="post" enctype="multipart/form-data" action="upload">
                <div class="mb-3" id="form__uploadFile">
                    <label for="formFile" class="form-label">Selecione o arquivo csv desejado</label>
                    <input class="form-control" type="file" id="formFile" name="transactions" required>      
                </div>

                <button id="submitButton" type="submit" class="btn btn-success">Enviar</button>
            </form>
            
            <h1 id="bigWarning"></h1>
            <h3 id="smallerWarning"></h3>
        </section>
        
        <button id="showTransactionsButton" type="submit" class="btn btn-primary mb-2">Mostrar Transações</button>

        <section id="transactions" class="w-75 mx-auto">
            <h2 id="transactions__title">Importações realizadas anteriormente</h1>
        
            <table id="transactions__table" class="table table-striped">
                <thead>
                    <tr>
                       <th>Datas das transações</th> 
                       <th>Datas de importação</th> 
                    </tr>
                </thead>
                <tbody id="transactions__table-body"></tbody>
            </table>
        </section>
    </main>

    <script>
        // Selecting all necessary elements
        const mainText = document.querySelector('#mainText');
        const bigWarning = document.querySelector('#bigWarning');
        const smallerWarning = document.querySelector('#smallerWarning');
        const uploadFile = document.querySelector('#form__uploadFile');
        const submitButton = document.querySelector('#submitButton');
        const showTransactionsButton = document.querySelector('#showTransactionsButton');
        const transactions = document.querySelector('#transactions');
        const transactionsTitle = document.querySelector('#transactions__title');
        const transactions__table = document.querySelector('#transactions__table');
        const transactionsTableBody = document.querySelector('#transactions__table-body');
    </script>

    <script>
        // Declaring non-event functions
        function fillTable(data) {
            data.forEach(datum => {
                const tr = document.createElement('tr');
                const tdTransactionDate = document.createElement('td');
                const tdImportDate = document.createElement('td');

                tdTransactionDate.textContent = new Date(datum.datetime).toLocaleDateString();
                tdImportDate.textContent = new Date(datum.importedAt).toLocaleString();
                tr.appendChild(tdTransactionDate)
                tr.appendChild(tdImportDate)
                transactionsTableBody.appendChild(tr);
            });
        }

        function getTransactions() {
            const headers = { 'Content-Type': 'application/json' };
            const init = {
                method:  'get',
                headers: headers,
                mode: 'cors'
            }
            fetch(`http://localhost:3333/transactions`, init)
            .then(resp => resp.json().then(response => {
                if (response.length === 0) {
                    transactions__table.style.display = 'none';
                    transactionsTitle.textContent = 'Transações ainda não foram importadas';
                } else {
                    transactions__table.style.display = '';
                    fillTable(response);
                }
            }))
            .catch(error => console.log(error))
        } 

        function dataNotValid() {
            bigWarning.textContent = 'Transações inválidas';
            smallerWarning.textContent = 'Não há transações registradas.';
        }
        
        function duplicatedData() {
            bigWarning.textContent = 'Transações inválidas';
            smallerWarning.textContent = 'O arquivo enviado já foi processado anteriormente.';
        }
        
        function dataIsValid() {
            bigWarning.textContent = 'Transações salvas com sucesso!';
            smallerWarning.textContent = '';
            transactions.style.display = 'block';
            showTransactionsButton.textContent = 'Esconder Transações';
        }
    </script>

    <script>
        // Defining window's load event
        window.onload = () => {
            const queryParams = {}
            const windowSearch = window.location.search;
            transactions.style.display = 'none';
            if(windowSearch) {
                window.location.search.substring(1).split('&').forEach(item => {
                    const param = item.split('=');
                    queryParams[param[0]] = param[1];
                });
                const dataIsInvalid = queryParams['valid'] && !Number(queryParams['valid']);
                const dataIsDuplicate = Number(queryParams['duplicate']);
                if (dataIsInvalid) dataNotValid();
                else if (dataIsDuplicate) duplicatedData();
                else dataIsValid();
            }
            getTransactions();
        }
    </script>

    <script>
        let showTransactions = false;
        showTransactionsButton.addEventListener('click', () => {
            showTransactions = !showTransactions;
            if(showTransactions) {
                transactions.style.display = 'block';
                showTransactionsButton.textContent = 'Esconder Transações'
            }
            else {
                transactions.style.display = 'none';
                showTransactionsButton.textContent = 'Mostrar Transações'
            }
        })
    </script>
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"
    ></script>
</body>
</html>